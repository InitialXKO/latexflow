这份 **PRD (产品需求文档)** 旨在指导开发一款名为 **"LatexFlow"** 的安卓应用，利用手写识别和蓝牙 HID 模拟技术，实现公式从纸面/屏幕到电脑的无感传输。

---

## 1. 产品概述

- **产品名称：** LatexFlow
- **定位：** 极客和科研工作者的手写公式输入辅助工具。
- **核心价值：** 消除手写公式到 LaTeX 代码之间的手动输入成本，利用蓝牙 HID 协议模拟物理键盘，实现“免客户端、一键注入”。

---

## 2. 功能需求 (Functional Requirements)

### 2.1 手写识别模块 (Input & OCR)

- **无限画布：** 提供低延迟的手写画布，支持多行公式书写。
- **笔迹处理：** 支持压力感应、笔触优化（橡皮擦、撤销/重做）。
- **OCR 引擎集成：** 调用高性能识别接口（如 MyScript iink），将笔迹转换为 LaTeX 字符串。
- **实时预览：** 使用 KaTeX 引擎渲染识别结果，用户可即时核对公式形态。

### 2.2 传输模块 (The "Magic" Link)

- **蓝牙 HID 模式 (核心)：**
  - 手机在系统层面注册为“蓝牙复合设备（键盘）”。
  - 无需电脑端安装任何软件，通过系统蓝牙配对即连。
- **一键注入 (Inject)：** 点击发送后，App 将 LaTeX 字符串解析为键盘键码流，模拟敲击发送至电脑。
- **自动转义：** 针对不同的电脑系统（Windows/macOS），自动适配键盘布局（如解决 `\` 或 `{` 在不同布局下的位置差异）。

### 2.3 历史记录与收藏

- **本地库：** 自动保存最近 20 条识别记录。
- **常用公式：** 支持收藏复杂公式（如 Maxwell 方程组），实现一键反复调用。

### 2.4 数学键盘输入 (Math Keyboard) [NEW]

- **交互增强：** 集成 GeoGebra 官方 `keyboard-base` 实现，作为手写输入的补充。
- **符号分类：** 提供与 GeoGebra 一致的完整数学符号体系（希腊字母、运算符、函数、矩阵模板等）。
- **布局切换：** 复用 GeoGebra 的布局逻辑，支持基础数学、函数、几何符号、希腊字母等切换。
- **LaTeX 集成：** 点击按键插入对应的 LaTeX 语法，并支持 GeoGebra 定义的复杂模板。

---

## 3. 用户流程 (User Journey)

1. **初次连接：** 打开 App，进入“配对模式”，在电脑蓝牙设置中发现并连接“LatexFlow Keyboard”。
2. **书写阶段：** 用户在手机画布上书写公式 。
3. **确认阶段：** App 底部实时显示预览，用户微调手写错误，识别自动更新。
4. **发送阶段：** 用户点击电脑上编辑器（如 Overleaf 或 Word）的光标位置，随后点击手机上的“注入”按钮。
5. **完成：** 公式代码快速自动“打”在电脑屏幕上。

---

## 4. 非功能需求 (Non-Functional Requirements)

- **超低延迟：** 笔迹到预览的转换延迟需控制在 500ms 以内。
- **兼容性：**
  - Android 端：支持 Android 9.0 (API 28) 及以上版本（HID API 要求）。
  - 电脑端：兼容 Windows、macOS、Linux、iPadOS。
- **鲁棒性：** 处理复杂 LaTeX 字符（如 `^`, `_`, `{`, `}`）时，需精确模拟键盘修饰键（Shift/Alt）。

---

## 5. 技术架构图 (Technical Architecture)

| 层级       | 技术栈                   | 作用                                          |
| ---------- | ------------------------ | --------------------------------------------- |
| **UI 层**  | Kotlin + Jetpack Compose | 响应式画布与现代 UI 交互                      |
| **算法层** | MyScript / Mathpix SDK   | 笔迹坐标转 LaTeX 文本                         |
| **协议层** | `BluetoothHidDevice` API | 定义 HID Report Map，模拟按键报文             |
| **逻辑层** | KeyMapper Engine         | 将 `\` 转为 `(Shift + [ScanCode])` 等逻辑处理 |

---

## 6. 后续迭代计划

- **V1.0：** 实现蓝牙键盘模拟与基础公式识别。
- **V1.1：** 增加“语音辅助修改”，例如说“上标写错了”触发局部重写。
- **V2.0：** 支持多行推导过程识别，并自动排版为 `\begin{aligned}` 格式。

---

### 需要详细制定一个“LaTeX 字符与键盘键码”的映射逻辑方案

这是实现该 PRD 中“一键注入”最关键的技术难点。
