name: Generate Release Keystore

on:
  workflow_dispatch:
    inputs:
      key_alias:
        description: "å¯†é’¥åˆ«å"
        required: true
        default: "key0"
      keystore_password:
        description: "å¯†é’¥åº“å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰"
        required: true
        default: "changeit123"
      key_password:
        description: "å¯†é’¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰"
        required: true
        default: "changeit123"
      validity_days:
        description: "æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰"
        required: true
        default: "10000"

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: ç”ŸæˆKeystore
        run: |
          keytool -genkeypair \
            -v \
            -keystore release.jks \
            -alias ${{ github.event.inputs.key_alias }} \
            -keyalg RSA \
            -keysize 2048 \
            -validity ${{ github.event.inputs.validity_days }} \
            -storepass ${{ github.event.inputs.keystore_password }} \
            -keypass ${{ github.event.inputs.key_password }} \
            -dname "CN=Developer, OU=Development, O=ExampleOrg, L=City, S=State, C=Country"

      - name: è·å–SHA1å’ŒSHA256ç­¾å
        id: get_signatures
        run: |
          echo "=== Keystore ä¿¡æ¯ ==="
          keytool -list -v -keystore release.jks \
            -storepass ${{ github.event.inputs.keystore_password }} \
            -alias ${{ github.event.inputs.key_alias }}

          echo ""
          echo "=== æå–ç­¾åä¿¡æ¯ ==="
          SHA1=$(keytool -list -v -keystore release.jks \
            -storepass ${{ github.event.inputs.keystore_password }} \
            -alias ${{ github.event.inputs.key_alias }} | \
            grep "SHA1:" | sed 's/.*SHA1: //')

          SHA256=$(keytool -list -v -keystore release.jks \
            -storepass ${{ github.event.inputs.keystore_password }} \
            -alias ${{ github.event.inputs.key_alias }} | \
            grep "SHA256:" | sed 's/.*SHA256: //')

          echo "sha1=$SHA1" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: è½¬æ¢Keystoreä¸ºBase64
        id: encode
        run: |
          BASE64_KEYSTORE=$(base64 -w 0 release.jks)
          echo "keystore_base64=$BASE64_KEYSTORE" >> $GITHUB_OUTPUT
          echo "âœ… Keystoreå·²è½¬æ¢ä¸ºBase64"

      - name: ä¸Šä¼ Keystoreæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: keystore-files
          path: release.jks
          retention-days: 7

      - name: ğŸ“‹ é…ç½®è¯´æ˜
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” ç­¾åè¯ä¹¦å·²ç”Ÿæˆï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "SHA1 ç­¾å: ${{ steps.get_signatures.outputs.sha1 }}"
          echo "SHA256 ç­¾å: ${{ steps.get_signatures.outputs.sha256 }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš™ï¸  GitHub Secrets é…ç½®æ­¥éª¤ï¼š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "å‰å¾€: Settings > Secrets and variables > Actions > New repository secret"
          echo ""
          echo "åˆ›å»ºä»¥ä¸‹4ä¸ªSecretsï¼š"
          echo ""
          echo "1. åç§°: KEYSTORE_FILE"
          echo "   å€¼: (æŸ¥çœ‹ä¸‹æ–¹Base64è¾“å‡º)"
          echo ""
          echo "2. åç§°: KEYSTORE_PASSWORD"
          echo "   å€¼: ${{ github.event.inputs.keystore_password }}"
          echo ""
          echo "3. åç§°: KEY_ALIAS"
          echo "   å€¼: ${{ github.event.inputs.key_alias }}"
          echo ""
          echo "4. åç§°: KEY_PASSWORD"
          echo "   å€¼: ${{ github.event.inputs.key_password }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ KEYSTORE_FILE Base64å€¼ï¼š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "${{ steps.encode.outputs.keystore_base64 }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… é…ç½®å®Œæˆåï¼Œå³å¯è§¦å‘ Release workflow æ„å»ºç­¾åAPK"
          echo ""
