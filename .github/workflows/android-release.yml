name: Android Release - Build & Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹: 1.0.0)"
        required: true
        default: "1.0.0"
permissions:
  contents: write # å…³é”®ï¼šå…è®¸åˆ›å»º Release
jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: è®¾ç½®Gradle Wrapper
        uses: gradle/gradle-build-action@v2

      - name: æˆäºˆGradleæ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: Check for required secrets
        id: check_secrets
        run: |
          if [ -n "${{ secrets.KEYSTORE_FILE }}" ] && [ -n "${{ secrets.KEYSTORE_PASSWORD }}" ] && [ -n "${{ secrets.KEY_ALIAS }}" ] && [ -n "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "has_secrets=true" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "Some required secrets are missing." >&2
          fi
        shell: bash
      - name: Decode and Save Keystore
        if: steps.check_secrets.outputs.has_secrets == 'true'
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > app/release.jks
      # æ–¹æ¡ˆ1ï¼šä½¿ç”¨GitHub Secretsé…ç½®ç­¾åï¼ˆæ¨èï¼‰
      - name: é…ç½®ç­¾åå¯†é’¥
        if: steps.check_secrets.outputs.has_secrets == 'true'
        run: |
          # è§£ç base64ç¼–ç çš„å¯†é’¥æ–‡ä»¶
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > release.jks

          # åˆ›å»ºkeystore.properties
          echo "storeFile=release.jks" > keystore.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties

      # æ–¹æ¡ˆ2ï¼šæœªé…ç½®ç­¾åæ—¶æ„å»ºæœªç­¾åAPK
      - name: æ„å»ºå‘å¸ƒç‰ˆAPK
        run: |
          if [ -f "keystore.properties" ]; then
            echo "ä½¿ç”¨ç­¾åé…ç½®æ„å»º..."
            ./gradlew assembleRelease --stacktrace
          else
            echo "âš ï¸ æœªé…ç½®ç­¾åï¼Œæ„å»ºè°ƒè¯•ç‰ˆAPK..."
            ./gradlew assembleDebug --stacktrace
            mkdir -p app/build/outputs/apk/release
            cp app/build/outputs/apk/debug/app-debug.apk app/build/outputs/apk/release/app-release.apk || true
          fi

      - name: é‡å‘½åAPK
        run: |
          cd app/build/outputs/apk/release
          if [ -f "app-release.apk" ]; then
            VERSION="${{ github.event.inputs.version }}"
            if [ -z "$VERSION" ]; then
              VERSION="${GITHUB_REF#refs/tags/v}"
            fi
            mv app-release.apk "app-v${VERSION}.apk"
            echo "APK_NAME=app-v${VERSION}.apk" >> $GITHUB_ENV
            echo "VERSION=$VERSION" >> $GITHUB_ENV
          fi

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸš€ App v${{ env.VERSION }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ğŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_OUTPUT
          echo "- **ç‰ˆæœ¬å·**: ${{ env.VERSION }}" >> $GITHUB_OUTPUT
          echo "- **åŒ…å**: com.growsnova.latexflow" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### âœ¨ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_OUTPUT
          echo "- æ–°ç‰ˆæœ¬å‘å¸ƒ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ğŸ“¥ å®‰è£…è¯´æ˜" >> $GITHUB_OUTPUT
          echo "1. ä¸‹è½½ APK æ–‡ä»¶" >> $GITHUB_OUTPUT
          echo "2. åœ¨è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…" >> $GITHUB_OUTPUT
          echo "3. å®‰è£…åº”ç”¨" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: app/build/outputs/apk/release/${{ env.APK_NAME }}
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ Release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: app/build/outputs/apk/release/${{ env.APK_NAME }}

      - name: æ„å»ºå®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ å‘å¸ƒç‰ˆæœ¬æ„å»ºå®Œæˆï¼"
          echo "ğŸ“± åº”ç”¨åŒ…å: com.growsnova.latexflow"
          echo "ğŸ·ï¸  ç‰ˆæœ¬: ${{ env.VERSION }}"
          if [ -f "keystore.properties" ]; then
            echo "âœ… ç­¾å: å·²ç­¾å"
          else
            echo "âš ï¸  ç­¾å: æœªç­¾åï¼ˆè¯·é…ç½®GitHub Secretsï¼‰"
          fi
